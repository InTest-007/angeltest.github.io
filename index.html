<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INNACRI - Navegaci√≥n Estilo Waze</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turf.js/6/turf.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; }
        
        body { 
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif; 
            background: #0a0e27; 
            overflow: hidden;
            color: #fff;
        }

        /* ========== CONTENEDOR PRINCIPAL ========== */
        .main-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* ========== MAPA PRINCIPAL ========== */
        #mapContainer {
            width: 100%;
            height: 100%;
            position: relative;
            background: #f5f5f5;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Estilo minimalista Waze */
        .leaflet-container {
            background: #f5f5f5 !important;
        }

        .leaflet-tile-pane {
            filter: grayscale(0%) brightness(0.95) contrast(1.1);
        }

        /* ========== PANEL SUPERIOR DE B√öSQUEDA ========== */
        .search-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.98) 0%, rgba(245, 245, 245, 0.95) 100%);
            backdrop-filter: blur(20px);
            padding: 16px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }

        .search-panel.hidden { 
            transform: translateY(-110%);
            pointer-events: none;
        }

        .search-title { 
            color: #1a1a1a; 
            font-size: 12px; 
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .search-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.05);
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 14px;
            color: #1a1a1a;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .search-input::placeholder { color: rgba(0, 0, 0, 0.4); }
        .search-input:focus { 
            outline: none; 
            background: rgba(0, 0, 0, 0.08);
            border-color: #5a7dd6;
            box-shadow: 0 0 20px rgba(90, 125, 214, 0.2);
            transform: translateY(-1px);
        }

        .btn-icon {
            background: rgba(90, 125, 214, 0.15);
            color: #5a7dd6;
            border: 1px solid rgba(90, 125, 214, 0.3);
            padding: 12px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover { 
            background: rgba(90, 125, 214, 0.25);
            border-color: #5a7dd6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(90, 125, 214, 0.2);
        }

        .btn-icon:active {
            transform: translateY(0);
        }

        .location-tag {
            background: rgba(76, 175, 80, 0.1);
            padding: 10px 14px;
            border-radius: 6px;
            color: #4CAF50;
            font-size: 11px;
            border-left: 3px solid #4CAF50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .location-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ========== PANEL DE RUTA ========== */
        .route-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(255, 255, 255, 0.98), rgba(245, 245, 245, 0.95));
            backdrop-filter: blur(20px);
            padding: 24px;
            z-index: 500;
            display: none;
            flex-direction: column;
            border-radius: 28px 28px 0 0;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
            max-height: 60vh;
            overflow-y: auto;
            border: 1px solid rgba(0, 0, 0, 0.05);
            animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .route-panel.show { display: flex; }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        .route-title { 
            color: #1a1a1a; 
            font-size: 20px; 
            font-weight: 700;
        }

        .route-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin-bottom: 20px;
            gap: 12px;
        }

        .stat {
            flex: 1;
            background: rgba(90, 125, 214, 0.08);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid rgba(90, 125, 214, 0.1);
            transition: all 0.3s;
        }

        .stat:hover {
            background: rgba(90, 125, 214, 0.12);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #5a7dd6;
        }

        .stat-label {
            font-size: 11px;
            color: rgba(0, 0, 0, 0.6);
            margin-top: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .instructions {
            max-height: 140px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .instructions::-webkit-scrollbar {
            width: 6px;
        }

        .instructions::-webkit-scrollbar-track {
            background: rgba(90, 125, 214, 0.05);
        }

        .instructions::-webkit-scrollbar-thumb {
            background: rgba(90, 125, 214, 0.3);
            border-radius: 3px;
        }

        .instructions::-webkit-scrollbar-thumb:hover {
            background: rgba(90, 125, 214, 0.6);
        }

        .instruction {
            padding: 12px;
            margin-bottom: 8px;
            color: #333;
            font-size: 13px;
            background: rgba(0, 0, 0, 0.03);
            border-left: 3px solid #5a7dd6;
            border-radius: 4px;
            line-height: 1.5;
        }

        .buttons-row {
            display: flex;
            gap: 12px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-start {
            background: linear-gradient(135deg, #5a7dd6 0%, #4a5fba 100%);
            box-shadow: 0 6px 20px rgba(90, 125, 214, 0.3);
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(90, 125, 214, 0.4);
        }

        .btn-real {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }

        .btn-real:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(76, 175, 80, 0.4);
        }

        /* ========== PANEL DE NAVEGACI√ìN WAZE ========== */
        .nav-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f5f5f5;
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        .nav-panel.active { display: flex; }

        .nav-map { 
            flex: 1; 
            position: relative;
            background: #f5f5f5;
        }

        #navMap { width: 100%; height: 100%; }

        /* HUD Waze Style */
        .nav-hud {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px);
            padding: 16px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .hud-distance {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .hud-route {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 4px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .hud-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            gap: 16px;
        }

        .nav-instruction-card {
            position: absolute;
            bottom: 100px;
            left: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 10;
        }

        .nav-icon-large {
            font-size: 56px;
            flex-shrink: 0;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .nav-instruction-text {
            flex: 1;
        }

        .nav-instruction-main {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
        }

        .nav-instruction-detail {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Controles Waze */
        .nav-controls {
            background: rgba(0, 0, 0, 0.9);
            padding: 16px;
            display: flex;
            gap: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }

        .btn-control {
            flex: 1;
            min-width: 80px;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }

        .btn-pause {
            background: rgba(255, 152, 0, 0.8);
        }

        .btn-pause:hover {
            background: rgba(255, 152, 0, 1);
        }

        .btn-close {
            background: rgba(244, 67, 54, 0.8);
        }

        .btn-close:hover {
            background: rgba(244, 67, 54, 1);
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .search-input {
                font-size: 16px;
            }

            .btn {
                font-size: 13px;
                padding: 14px;
            }

            .route-stats {
                flex-direction: row;
                gap: 8px;
            }

            .stat {
                padding: 12px;
            }

            .stat-value {
                font-size: 24px;
            }

            .instruction {
                font-size: 12px;
                padding: 10px;
            }
        }

        @media (max-width: 480px) {
            .search-panel {
                padding: 12px;
                gap: 10px;
            }

            .route-title {
                font-size: 16px;
            }

            .btn {
                font-size: 12px;
                padding: 12px;
                min-height: 44px;
            }

            .buttons-row {
                gap: 8px;
            }

            .route-panel {
                padding: 16px;
                max-height: 70vh;
                border-radius: 20px 20px 0 0;
            }

            .instructions {
                max-height: 100px;
            }

            .stat-value {
                font-size: 20px;
            }

            .nav-hud {
                top: 12px;
                left: 12px;
                right: 12px;
                padding: 12px 16px;
            }

            .hud-distance {
                font-size: 24px;
            }

            .nav-instruction-card {
                bottom: 80px;
                left: 12px;
                right: 12px;
                padding: 16px;
            }

            .nav-icon-large {
                font-size: 48px;
            }

            .nav-instruction-main {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- CONTENEDOR PRINCIPAL -->
    <div class="main-container">
        <!-- PANEL DE B√öSQUEDA -->
        <div class="search-panel" id="searchPanel">
            <div class="search-title">üó∫Ô∏è Buscar Ruta</div>

            <div class="search-row">
                <input type="text" class="search-input" id="originInput" placeholder="Punto de partida">
                <button class="btn-icon" id="btnGetLocation" title="Mi ubicaci√≥n">üìç</button>
            </div>

            <div class="search-row">
                <input type="text" class="search-input" id="destInput" placeholder="Destino">
                <button class="btn-icon" id="btnSearchRoute" title="Buscar">üîç</button>
            </div>

            <div class="location-tag" id="locationTag">
                <span class="location-dot"></span>
                <span id="locationText">Obt√©n tu ubicaci√≥n</span>
            </div>
        </div>

        <!-- MAPA -->
        <div id="mapContainer">
            <div id="map"></div>
        </div>

        <!-- PANEL DE RUTA -->
        <div class="route-panel" id="routePanel">
            <div class="route-header">
                <div class="route-title">Ruta Calculada</div>
            </div>

            <div class="route-stats">
                <div class="stat">
                    <div class="stat-value" id="routeDist">-</div>
                    <div class="stat-label">Distancia</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="routeTime">-</div>
                    <div class="stat-label">Tiempo</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="routeSpeed">-</div>
                    <div class="stat-label">Velocidad</div>
                </div>
            </div>

            <div class="instructions" id="instructions"></div>

            <div class="buttons-row">
                <button class="btn btn-start" id="btnStart">‚ñ∂ Simular</button>
                <button class="btn btn-real" id="btnReal">üõ∞Ô∏è Real</button>
            </div>
        </div>
    </div>

    <!-- PANEL DE NAVEGACI√ìN -->
    <div class="nav-panel" id="navPanel">
        <div class="nav-map">
            <div id="navMap"></div>

            <div class="nav-hud" id="navHud">
                <div class="hud-distance" id="navDist">0 km</div>
                <div class="hud-route" id="navRoute">-</div>
                <div class="hud-info">
                    <span id="navTime">-- min</span>
                    <span id="navSpeed">-- km/h</span>
                </div>
            </div>

            <div class="nav-instruction-card" id="navInstructionCard">
                <div class="nav-icon-large" id="navIcon">‚Üí</div>
                <div class="nav-instruction-text">
                    <div class="nav-instruction-main" id="navInst">Iniciando...</div>
                    <div class="nav-instruction-detail" id="navDetail">Prep√°rate</div>
                </div>
            </div>
        </div>

        <div class="nav-controls">
            <button class="btn-control btn-pause" id="pauseBtn">‚è∏ Pausar</button>
            <button class="btn-control btn-close" id="closeBtn">‚úï Cerrar</button>
        </div>
    </div>

    <script>
        // ========== VARIABLES GLOBALES ==========
        let map, navMap;
        let origin = null, dest = null;
        let route = [];
        let dist = 0, time = 0, speed = 0;
        let instructions = [];
        let navActive = false, navPaused = false, realMode = false;
        let navIdx = 0, progress = 0;
        let navInterval = null;
        let geoId = null;
        let userMarker = null;
        let synth = window.speechSynthesis;
        let lastInstructionTime = 0;
        let lastDistUpdateTime = 0;
        let routePolyline = null;
        let isOnline = navigator.onLine;

        // Ubicaciones predefinidas Guatemala
        const locations = {
            'zona 10': { lat: 14.6126, lng: -90.5218 },
            'zona 1': { lat: 14.6307, lng: -90.5010 },
            'zona 15': { lat: 14.6411, lng: -90.4880 },
            'aeropuerto': { lat: 14.3583, lng: -90.6525 },
            'ciudad vieja': { lat: 14.4242, lng: -90.7378 },
            'antigua': { lat: 14.5729, lng: -90.7381 },
            'centrohist√≥rico': { lat: 14.6307, lng: -90.5010 }
        };

        // ========== INICIALIZACI√ìN ==========
        function init() {
            // Crear mapa con estilo minimalista
            map = L.map('map', {
                center: [14.6343, -90.5069],
                zoom: 12,
                zoomControl: false,
                attributionControl: false,
                preferCanvas: true
            });

            // Tile layer con estilo minimalista tipo Waze
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                minZoom: 10,
                attribution: '',
                crossOrigin: true,
                subdomains: ['a', 'b', 'c', 'd']
            }).addTo(map);

            // Event listeners
            document.getElementById('btnGetLocation').addEventListener('click', getLocation);
            document.getElementById('btnSearchRoute').addEventListener('click', searchRoute);
            document.getElementById('btnStart').addEventListener('click', startNav);
            document.getElementById('btnReal').addEventListener('click', startReal);
            document.getElementById('pauseBtn').addEventListener('click', togglePause);
            document.getElementById('closeBtn').addEventListener('click', endNav);

            // Enter en inputs
            document.getElementById('originInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') searchRoute();
            });
            document.getElementById('destInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') searchRoute();
            });

            console.log('INNACRI - Estilo Waze inicializado');
        }

        // ========== UBICACI√ìN ==========
        function getLocation() {
            if (!navigator.geolocation) {
                alert('Geolocalizaci√≥n no disponible');
                return;
            }

            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                origin = { lat: latitude, lng: longitude };
                document.getElementById('originInput').value = 'Mi ubicaci√≥n';
                document.getElementById('locationText').textContent = `üìç ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                map.setView([latitude, longitude], 15);
            }, () => alert('Permiso denegado'));
        }

        // ========== B√öSQUEDA ==========
        function searchRoute() {
            const originText = document.getElementById('originInput').value.trim().toLowerCase();
            const destText = document.getElementById('destInput').value.trim().toLowerCase();

            if (!originText || !destText) {
                alert('Ingresa origen y destino');
                return;
            }

            // Buscar ubicaci√≥n de origen
            if (originText === 'mi ubicaci√≥n' && origin) {
                // Ya tenemos origen
            } else if (locations[originText]) {
                origin = locations[originText];
            } else {
                alert('Origen no encontrado');
                return;
            }

            // Buscar destino
            if (locations[destText]) {
                dest = locations[destText];
                calculateRoute();
            } else {
                alert('Destino no encontrado. Prueba: zona 10, zona 1, aeropuerto, antigua');
            }
        }

        function calculateRoute() {
            if (!origin || !dest) return;

            const d = turf.distance([origin.lng, origin.lat], [dest.lng, dest.lat], { units: 'kilometers' });
            route = [[origin.lng, origin.lat], [dest.lng, dest.lat]];
            
            dist = (d * 1).toFixed(1);
            time = Math.round((d / 40) * 60);
            speed = 40;

            document.getElementById('routeDist').textContent = dist + ' km';
            document.getElementById('routeTime').textContent = time + ' min';
            document.getElementById('routeSpeed').textContent = '40 km/h';

            // Instrucciones
            instructions = [
                { icon: '‚ñ∂', text: 'Comienza tu viaje', name: 'Tu ubicaci√≥n' },
                { icon: '‚Üí', text: 'Contin√∫a por la ruta', name: 'Camino principal' },
                { icon: 'üéØ', text: 'Llegada', name: 'Destino' }
            ];

            document.getElementById('instructions').innerHTML = instructions
                .map(i => `<div class="instruction"><strong>${i.text}</strong> en ${i.name}</div>`)
                .join('');

            document.getElementById('routePanel').classList.add('show');
            redraw();
        }

        function redraw() {
            map.eachLayer(l => {
                if (l instanceof L.Marker || l instanceof L.Polyline) map.removeLayer(l);
            });

            if (origin) {
                L.circleMarker([origin.lat, origin.lng], {
                    radius: 8,
                    fillColor: '#4CAF50',
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
            }

            if (dest) {
                L.circleMarker([dest.lat, dest.lng], {
                    radius: 8,
                    fillColor: '#f44336',
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
            }

            if (route.length > 0) {
                // Ruta con gradiente (azul a p√∫rpura)
                const segments = [];
                for (let i = 0; i < route.length - 1; i++) {
                    const ratio = i / route.length;
                    const hue = 240 - (ratio * 60); // Azul a p√∫rpura
                    const color = `hsl(${hue}, 100%, 50%)`;
                    
                    segments.push(
                        L.polyline([[route[i][1], route[i][0]], [route[i+1][1], route[i+1][0]]], {
                            color: color,
                            weight: 6,
                            opacity: 0.8,
                            lineCap: 'round',
                            lineJoin: 'round'
                        }).addTo(map)
                    );
                }
            }

            if (origin && dest) {
                const b = L.latLngBounds([origin.lat, origin.lng], [dest.lat, dest.lng]);
                map.fitBounds(b, { padding: [100, 100] });
            }
        }

        // ========== NAVEGACI√ìN ==========
        function startNav() {
            navActive = true;
            navPaused = false;
            realMode = false;
            navIdx = 0;
            progress = 0;
            document.getElementById('navPanel').classList.add('active');
            document.getElementById('searchPanel').classList.add('hidden');
            initNavMap();
            nav();
        }

        function startReal() {
            if (!origin) {
                alert('Primero obt√©n tu ubicaci√≥n');
                return;
            }

            navActive = true;
            navPaused = false;
            realMode = true;
            navIdx = 0;
            document.getElementById('navPanel').classList.add('active');
            document.getElementById('searchPanel').classList.add('hidden');
            initNavMap();

            if (!navigator.geolocation) {
                alert('Geolocalizaci√≥n no disponible');
                return;
            }

            navigator.geolocation.watchPosition(
                newPos => {
                    const newLoc = { lat: newPos.coords.latitude, lng: newPos.coords.longitude };
                    const moved = turf.distance([origin.lng, origin.lat], [newLoc.lng, newLoc.lat], { units: 'kilometers' });
                    dist = Math.max(0, parseFloat(dist) - moved).toFixed(1);
                    speed = Math.round((newPos.coords.speed || 0) * 3.6);
                    origin = newLoc;
                    
                    if (userMarker) {
                        userMarker.setLatLng([newLoc.lat, newLoc.lng]);
                        navMap.setView([newLoc.lat, newLoc.lng], 17);
                    }
                    updateNavDisplay();
                },
                () => {},
                { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
            );
        }

        function initNavMap() {
            if (navMap) navMap.remove();
            navMap = L.map('navMap', {
                zoomControl: false,
                attributionControl: false,
                preferCanvas: true
            }).setView([origin.lat, origin.lng], 16);

            // Mismo tile layer minimalista
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                attribution: '',
                crossOrigin: true,
                subdomains: ['a', 'b', 'c', 'd']
            }).addTo(navMap);

            if (route.length > 0) {
                const segments = [];
                for (let i = 0; i < route.length - 1; i++) {
                    const ratio = i / route.length;
                    const hue = 240 - (ratio * 60);
                    const color = `hsl(${hue}, 100%, 50%)`;
                    
                    L.polyline([[route[i][1], route[i][0]], [route[i+1][1], route[i+1][0]]], {
                        color: color,
                        weight: 7,
                        opacity: 0.8,
                        lineCap: 'round',
                        lineJoin: 'round'
                    }).addTo(navMap);
                }
            }

            userMarker = L.circleMarker([origin.lat, origin.lng], {
                radius: 10,
                fillColor: '#5a7dd6',
                color: '#fff',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.9
            }).addTo(navMap);
        }

        function nav() {
            if (!navActive || navPaused || realMode) return;

            progress += 0.002;
            if (progress > 1) progress = 1;

            const currentTime = Date.now();

            if (userMarker && route.length > 0) {
                const idx = Math.floor(progress * (route.length - 1));
                const coord = route[idx];
                userMarker.setLatLng([coord[1], coord[0]]);
                navMap.setView([coord[1], coord[0]], 17);
            }

            if (!lastInstructionTime || currentTime - lastInstructionTime > 2000) {
                if (navIdx < instructions.length) {
                    const inst = instructions[navIdx];
                    document.getElementById('navIcon').textContent = inst.icon;
                    document.getElementById('navInst').textContent = inst.text;
                    document.getElementById('navDetail').textContent = inst.name;
                    speakInstruction(inst.text + ' en ' + inst.name);
                    navIdx++;
                    lastInstructionTime = currentTime;
                }
            }

            if (!lastDistUpdateTime || currentTime - lastDistUpdateTime > 333) {
                dist = Math.max(0, parseFloat(dist) - 0.15).toFixed(1);
                time = Math.max(1, time - 1);
                lastDistUpdateTime = currentTime;
            }

            speed = Math.round(40 + Math.random() * 20);
            updateNavDisplay();

            if (parseFloat(dist) > 0) {
                navInterval = requestAnimationFrame(nav);
            } else {
                finish();
            }
        }

        function updateNavDisplay() {
            document.getElementById('navDist').textContent = dist + ' km';
            document.getElementById('navTime').textContent = time + ' min';
            document.getElementById('navSpeed').textContent = speed + ' km/h';
        }

        function speakInstruction(text) {
            synth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'es-ES';
            u.rate = 0.9;
            u.pitch = 0.95;
            try { synth.speak(u); } catch (e) { }
        }

        function finish() {
            navActive = false;
            document.getElementById('navIcon').textContent = '‚úì';
            document.getElementById('navInst').textContent = '¬°LLEGASTE!';
            document.getElementById('navDetail').textContent = 'Gracias por usar INNACRI';
            speakInstruction('Felicidades, has llegado a tu destino');
            setTimeout(endNav, 3000);
        }

        function togglePause() {
            navPaused = !navPaused;
            const btn = document.getElementById('pauseBtn');
            if (navPaused) {
                btn.textContent = '‚ñ∂ Reanudar';
                synth.pause();
            } else {
                btn.textContent = '‚è∏ Pausar';
                if (synth.paused) synth.resume();
                if (!realMode) nav();
            }
        }

        function endNav() {
            navActive = false;
            navPaused = false;
            realMode = false;
            cancelAnimationFrame(navInterval);
            synth.cancel();
            if (geoId !== null) navigator.geolocation.clearWatch(geoId);
            document.getElementById('navPanel').classList.remove('active');
            document.getElementById('searchPanel').classList.remove('hidden');
            if (navMap) navMap.remove();
        }

        // Inicializar
        init();
    </script>
</body>
</html>
